<!DOCTYPE html>
<html>
  <head>
    <title>Unofficial RDWorks decoder.</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description=" content="Unofficial machine code viewer for
    your Ruida Laser Controller">
    <link rel="stylesheet" href="daMsg.css">
  </head>

  <body>
    <div class="container">
      <label class="buttyG">
          <input type='file' onchange='openFile(event)'/>
          <!-- Open icon by Icons8 -->
          <img class="icon"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAACeUlEQVRoQ+2a4VncMAyGXyYAJihMQJmAMgEwATBBYYLCBC0TtExAO0HLBLQTABMAE9Dnuyfyc7nIIQnB6A78886J9Vr6JNl3SyzIWFoQDt5Bonly1iNfgV1grYOhN8Ap8KPD3BefMg3yDfg8YMVN4O+A50Z9ZBrkDlgBuhp2AnwB5Jn1Ua0a8LJpkMfq+T4JQJ7YqMLrcMD6oz3yXJCPwNVo1rS/SJ6XHqXLxnguiF54AEhfy4WABKKwro0xQArZj3nf1eQ8gWjDsjqeN5Cs998USJ9qX0ovtk7KZE95ZGi1Lw10+hRI32pfGiBlsjYQNY7XwEPVupQ2sst6ycY2EHXBF8Al8KnLW19hjuz6LRvbQKwpdCvpKxjtLWk2nrWB/AG2gD3gZxDDZ81Q77UPHLaBSB+KQbXoSnMRhxpWCX47B6JziTKWRp+2vjRsallyIElEgYVuqfdWkZMDSSICjkpvc8f1dHz4DvzSPUMOROLekYiiXC44cLWsmgMxoXc9v3fcxFGn1bKqB7I6J0KvZVUPZNuqZWChN7KqB3IMqHU/Cyz0Rlb1QM6raikgtfERhzKpNlu2KnvVip0VF91VTaolIEFFHNaapM32PGKGR67olrHSZudA/lVeiegN2WTRowx7nwstfZ5iLyCJHaYmrYkXPkap7yIL3T3w5UIrstDdA18OJLLQ3T7QA6nFXkCNuH2gBzJpiwMCmEnu/a8HEvmywVqTRnnINY1RK7odphrlIdfGT4pMwNFoTbw6opuSDz1+DC3NafVD6zZudqY9Yvm5tIF913OPF7P1QjCKQ3km2pDAdaxw/6AQufD12sh3kF7bVWDywnjkP4mInHIP+DzUAAAAAElFTkSuQmCC">
          Open
      </label>
      <input id="open" type='file' >
      <div id="mySpan">
        Please open a rd-file. Modify and then download it if you like.
      </div>

      <button class="buttyG" type="button" onclick='info();'>
        <!-- Info icon by Icons8 -->
          <img class="icon"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAD30lEQVRoQ+2agXHUQAxFlQqACiAVABUAFQAVECoAKgAqIKkAUgFQAaSCJBVAKgAqgHme/R7Z57XX9uruwkQznosn9q6+vqTVan1g9eSemT0yswfp4p7Ly08z47pI11m6X63FwcoRUPSFmR0NKF06NMCOzezrGlBLgQDgbQIghf+Y2fdkaX5lfQ9ILD1OrPF7yz3wyczeLwE0F8htM/vQA3BqZl/SVcqCf+6ZmXHBrARAb8zsd+mAc4Aw2UczAwzWxx24iiebUAq2cNHXiSXGfVlqoFIgsMAECL7M37hOhAAIRkgcCMaCnVGZAoL1P5sZvgwLAGCSbQjsAIIYIuaej7E/BgQQ31JQAgIwpM1tCqkcEIBh7ic5MGNAAIHylykYo1xpyjCAwQvup3iBmQ3JAYHSV8mdGGhXIKSwZ+bExWsLaAgI2Ym42JU75RjyYGCFlJ8FQlz8SCmW1LetwJ5yL/2fBMASQGo+9PHSZwTFWZhIsTCzj0Lwk5pZiAHWiAdC/oYNXKpWXLxLpQxzUXpwv1bQkwxGJoOVJn49ELFRa0LGjwDix21ZERCxwUN3KpYdUUC8vg0rAqIJO3631gdSaa89yVA1vGYKeRDly7GAEBtMuJHW1swU/K6WCQx0CBAf5KTf6ySk4SboAaLcvM8pN2dcFsWnlPsAUTlSM1v5BUwbJuKv9gKr2D4BiBYYKkv+rilRWUs6UtRS3J4BRIHeLi4VkUQDYeE+V/r9O7DK18ISDQQ9G/1h5AZIAW03jBQYSY+0rsXKeNdXkjMGmXo0mhEt5lf/VfqNXBCjGeksiJElSjSQTokiP6MAYy9SU6KB/Er9haZoRBTwtcv4SCAq46+o4AWEVij93dobq0gggxurja1jJf+KApLd6qL3dWo+KNNuNB8A4oP+YaU2aQQj6EnFy252sB3kWSGtDTaLZ7qcPxCt1XxQcz3boENHUDIh++B9bJkqKdFExEjtadlYE5uH2DVu+0wkRzqbKNjA2JNNbA2iYAJMrXiZ6ZWdxz2I4mMFjaC9PIxggV2dkQCCDjy/2U7P1NEbYDgp2pWbeSY4OaPZMHiKXHIYSgajjc8AtCdrt3RyLseJGembmIAJitvsUfgUkH7McA9LZLQoVyMb4UpYHxmMiT76UiC8R5EGG6RmLENCIJfXAqTvWnSGQoqFhc4RW46+OUC0zgCg/7kFk0H/EqHliZHa06dkINaM4q8q5gKRolgPy3lATOo/qqG87rPFe/QH/Ec1vnEOw4w7m+WlQDwgrIn1UHCJABiWYXU2AE24FohXHGvL0qRNWd8/I5b04Zk+h1pigM47/wD31ROdPAPfrQAAAABJRU5ErkJggg==">
      </button>
      <button class="buttyG" type="button" onclick='download();'>
        <!-- File icon by Icons8 -->
          <img class="icon"  src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAABwklEQVRoQ+2Z4U3EMAyF320AE8AGwATABDACGzACdxswAiPABMAGMAITwAaHnpRIUXWtmzi5uJUj3Y9UaeLP9nPS3AYraZuVcEAC2TcE/QJwC+Cvxho9QWh/NZi5INK4XKemka4CIxkYF5TGlYJ8A7ioERnJwNYgpwA+asD0BuH6JzVgLIAwLdUwVkDUMJZAVDDWQIphLIIUwVgFyYbpDZKzkfIEcDX2wpJAyDBqby+QnEhwrHjCcJBclyrHe0SiA0VPKD19DuAMwKcwj2hHb41sATxNVaMA6CDHSi3zEeFX3yuAawA34baEO/M9gEcA1Ab7P6GvTnH1BCMijTlNERPqJRj/DuAt9AlIqMkdu7dGCEKDGYHYGCFG4jJ59ryEiOwAUAOp3obPzGuEEVktCK9GmUpplBYZEQqeVYzfFPG+l7q5s7Qh0jBWpyjuQ6kVS+5vqFocyws6HlHU1VM9QVAyU4T7Aj3Mxj7B+EsbK9ZDqF5xr2E/TbdDFd38EWXumdNBjnXW8ogMPVBL7HM9WzrONeIaKc0d4T1PLU8tT61pD7hGhhpplDHZ06r/VshesdELxSCN7Kk/rXTWqr9ioxn/ATtPsDOnVj9tAAAAAElFTkSuQmCC">
        Download
      </button>
    </div>
    <div class="msg-container">
      <textarea id="myNr" readonly> </textarea>
      <textarea id="myMessage">...</textarea>
      <textarea id="myDescription" readonly> </textarea>
      <textarea id="myHex" readonly> </textarea>
    </div>

    <!-- The Download Modal -->
    <div id="myDownloadModal" class="modal">
      <div class="mItem">
        <span class="close"> &times;</span>
      </div>
      <div class="mItem">
        hello
      </div>
      <div class="mItem">
        File name:
        <input id="fileName" type="text" name="fname" required placeholder="default.rd" onclick='downloadReady()'>
        <a id="download" style="visibility: hidden;" href=""type="button" href='' download="default.rd" >
          Download
        </a>
      </div>
    </div>

    <!-- The Info Modal -->
    <div id="myInfoModal" class="modal">
      <div>
        <span class="close" onclick="infoClear();"> &times;</span>
      </div>
      <div>
        <h1>Und</h1>
        <p>This id info...</p><br>
        <p>Ya jahjsaj</p>
      </div>
    </div>
  </body>

  <script src="RD6442.js" ></script>
  <script type="text/javascript">
    Array.prototype.extend = function (other_array) {
      other_array.forEach(function(v) {this.push(v)}, this);
    }
    var mySpan = document.getElementById('mySpan');
    var myMessageArea = document.getElementById('myMessage');
    var myNrArea = document.getElementById('myNr');
    var myHexArea = document.getElementById('myHex');
    var myDescArea = document.getElementById('myDescription');
    var myModal = document.getElementById('myDownloadModal');
    var myDownload = document.getElementById('download');
    var myInfo = document.getElementById('myInfoModal');
    //var click = document.getElementById('click');
    var close = document.getElementsByClassName("close")[0];
    var fileName = document.getElementById('fileName');

    var openFile = function(event) {
      var input = event.target;
      var myFile = input.files[0];
      var reader = new FileReader();
      var msg;

      reader.onload = function(){
        mySpan.innerHTML = "working..."; // This isn't diplayed??
        //console.log('Load');
        if (input.files && myFile) {
          var uint8Array  = new Uint8Array(reader.result);
          console.log('Bytes: '  + reader.result.byteLength);
          msg = createMsgString(descramble(uint8Array));
          myNrArea.value = msg[0];
          myMessageArea.value = msg[1];
          myDescArea.value = msg[2];
          myHexArea.value = msg[3];
          autoresize(myNrArea, myMessageArea, myDescArea, myHexArea);
          mySpan.innerHTML = "Done.";
        };
      };
      reader.readAsArrayBuffer(myFile);
    };

    function info() {
      myInfo.style.visibility = "visible";
    }
    function infoClear() {
      myInfo.style.visibility = "hidden";
    }
    function download() {
    //  myDownload.href = "data:text/plain;charset=utf-8," + prepareForSave(myMessageArea.value);
      saveByteArray([prepareForSave(myMessageArea.value)], "test.rd");
      //myDownload.href = "data:text/plain;charset=utf-8," + encodeURIComponent(myHexArea.value); // here line brakes will be included
    //  myDownload.href = "data:application/octet-stream;base64," + myHexArea.value ;

    //  myModal.style.visibility = 'visible';
    //  myDownload.style.visibility = "visible";
    }
    function downloadReady() {
      myDownload.style.visibility = "visible";
    }
    function clear() {
      myModal.style.visibility = 'hidden';
      myDownload.style.visibility = "hidden";
      fileName.value = "";
    }
    // When the user clicks on <span> (x), close the modal
    close.onclick = function() {
      clear();
    }
    myDownload.onclick = function() {
      clear();
    }
    fileName.onchange = function() {
      myDownload.download = fileName.value;
      //console.log("File name: "+ fileName.value);
    }

    function saveByteArray(data, name) {
      var blob = new Blob(data, {type: 'octet-stream'}),
          url = URL.createObjectURL(blob);
      console.log("blob size: " + blob.size);
      console.log("blob type: " + blob.type);
      console.log("blob url: " + url);
      myDownload.href = url;
      myDownload.download = name;
      myDownload.click();
      window.URL.revokeObjectURL(url);
    };

    function prepareForSave(text) {
      //console.log("Save this: " + text);
      var reg = /\r|\r\n|\n/;
      var lines = text.split(reg);
      var returnArray = [];
      var i, len = lines.length;
      var ignore = 0;

      console.log("Save proc. started. Nr of lines: " + len);
      for (i = 0; i < len; i++) {
        if (lines[i].includes("(") && lines[i].includes(")")) {
          // Hex line
          returnArray.extend(splitHexLine(lines[i]));
        }
        else if (lines[i].includes("<") && lines[i].includes(">")) {
          //console.log(lines[i]);
          // Formatted line.
          var ret = formatted(lines[i]);
          console.log("Formatted: " + myPrint(ret));
          returnArray.extend(ret);
        }
        else {
          // Unknown - Ignore line
          ignore++;
        }
        //console.log("V: " + hex);
      }

      //console.log("Result: " + returnArray);
      var rArray = new Uint8Array(returnArray);
      var byteArray = new Uint8Array(returnArray.length);
      for (var x = 0; x < byteArray.length; x++){
          byteArray[x] = returnArray[x];
      }
      return byteArray;
    }

    function myPrint(array) {
      var st = '';
      for (var i = 0; i < array.length; i++) {
        st += array[i].toString(16) + ' ';
      }
      return st;
    }

    function splitHexLine(line) {
      var returnArray = [];
      var reg = /\s|\(|\)/;
      var splity = line.split(reg);
      var i, len = splity.length;

      for (i = 0; i < len; i++) {
        if (splity[i] != "") {
          returnArray.push(scrambleByte(parseInt(splity[i], 16)));
        }
      }
      //  console.log(returnArray);

      return new Uint8Array(returnArray);
    }

    function formatted(line) {
      var returnArray = [];
      var reg = /\<|\>/;
      var splity = line.split(reg);
      var i, len = splity.length;
      var msgP;

      msgP = messageProperties[splity[1]];
      // Write message type
      if (msgP != null) {
        //console.log(splity);
        returnArray.push(scrambleByte(parseInt(splity[1].substring(0,2), 16)));
        if (splity[1].length > 3) {
          returnArray.push(scrambleByte(parseInt(splity[1].substring(3), 16)));
        }

        switch (msgP[0]) {
          case 0:
            //console.log("Type 0: ");
            returnArray.extend(encodeDataType0(splity[2], msgP));
            break;
          case 1:
            //console.log("Type 1: ");
            returnArray.extend(encodeDataType1(splity[2], msgP));
            break;
          default:

        }
      }
      else {
        // Typo??
      }

      return new Uint8Array(returnArray);
    }

    function encodeDataType0(data, msgP) {
      var returnArray = [];
      var reg = /\[|\]/;
      var splity = data.split(reg);
      var s = 1;
      var i;
      var crap;

      //console.log(splity);
      if (msgP[1]) {
        //console.log("LAYER: " + parseInt(splity[1].substring(0,2), 16));
        returnArray.push(scrambleByte(parseInt(splity[1].substring(0,2), 16)));
        s = 3;
      }

      for (i = 0; i < msgP[2]; i++) {
        //console.log(splity[s]);
        crap = parseInt(parseFloat(splity[s])/parseFloat(msgP[6]));
      //  console.log("Crap: " + crap + " hex: " + crap.toString(16)
      //    + " length: " + crap.toString().length);

        returnArray.extend(splitAndShift(crap, msgP[3]));
        s += 2;
      }
      return returnArray;
    }

    function encodeDataType1(data, msgP) {
      var returnArray = [];
      var reg = /\[|\]/;
      var splity = data.split(reg);
      var s = 1;
      var i;
      //console.log(splity);
      if (msgP[1]) {
        returnArray.push(scrambleByte(parseInt(splity[1].substring(0,2), 16)));
        s = 3;
      }
      returnArray.push(scrambleByte(parseInt(splity[s], 16)));
      return returnArray;
    }

  function splitAndShift(value, nrOfBytes) {
    var returnArray = [];
    var byte;
    var i;
    var start = nrOfBytes - 1;

    for (i = start; i >= 0; i--) {
      byte = ((value >>> (7 * i)) & 0x7F).toString();
      //console.log("Shift byte: " + byte);
      returnArray.push(scrambleByte(parseInt(byte)));
    }
    return returnArray;
  }

    function descramble(array) {
      var magic = 0x88;
      var a, b, i;
      var aLength = array.length;
      var returnArray = new Uint8Array(aLength);

      for (i = 0; i < aLength; i++) {
        a = (array[i] + 0xFF) & 0xFF; //subtract 1 with wrap-around
        b = a ^ magic; //bit-wise exclusive OR with magic number
        //swap first and last bit
        returnArray[i] = (b & 0x7E) | ((b >> 7) & 0x01) | ((b << 7) & 0x80);
      /*  console.log('Return: ' + returnArray[i] +
        ', Hex: ' + returnArray[i].toString(16) +
        ', Binary: ' + returnArray[i].toString(2));*/
      }
      return returnArray;
    }

    function scramble(array) {
      var i;
      var aLength = array.length;
      var returnArray = new Uint8Array(aLength);

      for (i = 0; i < aLength; i++) {
        returnArray[i] = scrambleByte(array[i]) ;
      }
      return returnArray;
    }

    function scrambleByte(byte) {
      var magic = 0x88;
      //swap first and last bit
      var a = (byte & 0x7E) | ((byte >> 7) & 0x01) | ((byte << 7) & 0x80);
      //bit-wise exclusive OR with magic number
      var b = a ^ magic;
      //add 1 with wrap-around
      return (b + 1) & 0xFF;
      //return byte;
    }

    function createMsgString(array) {
      var result = ["", "", "", ""];
      var mask = 0x80;
      var firstTime = true;
      var tmp = "";
      var decoded;
      var count = 1;
      var i;
      var len = array.length;

      for (i = 0; i < len; i++) {
        if(array[i] & mask) {
          if(firstTime) {
            // start a new message
            firstTime = false;
          }
          else {
            // save message
            decoded = decodeMsgToString(tmp); // Byta namn
            result[0] += count++ + "\n";
            result[1] += decoded[0] + "\n";
            result[2] += decoded[1] + "\n";
            result[3] += decoded[2] + "\n";
          }
          tmp = fixHex(array[i]);
        }
        else {
          tmp += " " + fixHex(array[i]);
        }
        // last index/message - Ugly fix
        if ((i + 1) == len ) {
          // save message
          decoded = decodeMsgToString(tmp); // Byta namn
          result[0] += count++;
          result[1] += decoded[0];
          result[2] += decoded[1];
          result[3] += decoded[2];
        }
      }
      return result;
    }

    function fixHex(byte) {
      var result = byte.toString(16).toUpperCase();

      if (result.length < 2) {
        result = "0" + result;
      }

      return result;
    }

    function autoresize(nr, msg, desc, hex) {
      var lines = msg.value.split(/\r|\r\n|\n/);
      //var count = lines.length;
      console.log('Lines: '+ lines.length);
      //msg.style.height = 'auto';
      msg.style.height = msg.scrollHeight+'px';
      msg.scrollTop = msg.scrollHeight;
      nr.style.height = msg.style.height;
      desc.style.height = msg.style.height;
      hex.style.height = msg.style.height;
    //window.scrollTo(window.scrollLeft,(this.scrollTop+this.scrollHeight));
    }
  </script>
</html>
